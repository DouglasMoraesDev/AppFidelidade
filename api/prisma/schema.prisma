generator client {
  provider = "prisma-client-js"
  // Gerar engines para múltiplos binários OpenSSL para compatibilidade em diferentes runtimes
  // Inclui `debian-openssl-1.1.x` (Railway/ambientes antigos) e `debian-openssl-3.0.x` (ambientes mais novos)
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Estabelecimento {
  id               Int      @id @default(autoincrement())
  nome             String
  endereco         String?
  cpf_cnpj         String?
  telefone         String?
  email            String?  @unique
  logo_path        String?
  mensagem_voucher String?   @db.Text
  pontos_para_voucher Int    @default(10)
  assinaturaValidaAte DateTime?
  nome_app         String   @default("AppFidelidade")
  slug_publico     String   @unique
  link_consulta    String?
  tema_config      String?   @db.Text
  auto_notificar_voucher Boolean @default(false)
  lembrete_pontos_proximos Boolean @default(false)
  createdAt        DateTime @default(now())

  usuarios Usuario[]
  cartoes  CartaoFidelidade[]
  vouchers Voucher[]
  pagamentos MensalidadePagamento[]
  notificacoes Notificacao[]
  pushSubscriptions PushSubscription[]
}

model Usuario {
  id                Int      @id @default(autoincrement())
  estabelecimentoId Int
  nomeUsuario       String
  senhaHash         String
  papel             String   @default("operador")
  criadoEm          DateTime @default(now())

  estabelecimento Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
}

model Cliente {
  id       Int      @id @default(autoincrement())
  nome     String
  telefone String
  criadoEm DateTime @default(now())

  cartoes  CartaoFidelidade[]
  vouchers Voucher[]
}

model CartaoFidelidade {
  id                Int      @id @default(autoincrement())
  codigo            String   @unique
  clienteId         Int
  estabelecimentoId Int
  pontos            Int      @default(0)
  criadoEm          DateTime @default(now())

  cliente         Cliente         @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  estabelecimento Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
  movimentos      Movimento[]
  vouchers        Voucher[]

  @@unique([clienteId, estabelecimentoId], name: "cartao_cliente_estabelecimento_unique")
}

model Movimento {
  id        Int      @id @default(autoincrement())
  cartaoId  Int
  tipo      String
  pontos    Int
  descricao String?
  criadoEm  DateTime @default(now())

  cartao CartaoFidelidade @relation(fields: [cartaoId], references: [id], onDelete: Cascade)
}

model Voucher {
  id                Int      @id @default(autoincrement())
  cartaoId          Int
  clienteId         Int
  estabelecimentoId Int
  mensagem_enviada  String
  numero_cliente    String
  enviado_por_id    Int
  criadoEm          DateTime @default(now())
  status            String   @default("enviado")

  cartao          CartaoFidelidade @relation(fields: [cartaoId], references: [id], onDelete: Cascade)
  cliente         Cliente          @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  estabelecimento Estabelecimento  @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
}

model MensalidadePagamento {
  id                Int      @id @default(autoincrement())
  estabelecimentoId Int
  pagoEm            DateTime @default(now())

  estabelecimento Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
}

model Notificacao {
  id                Int      @id @default(autoincrement())
  estabelecimentoId Int
  titulo            String
  mensagem          String   @db.Text
  tipo              String   @default("info") // info, aviso, promocao, atualizacao
  lida              Boolean  @default(false)
  criadaEm          DateTime @default(now())

  estabelecimento Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)

  @@index([estabelecimentoId, lida])
}

model PushSubscription {
  id                Int      @id @default(autoincrement())
  estabelecimentoId Int
  endpoint          String   @db.VarChar(512)
  keys_p256dh       String   @db.VarChar(255)
  keys_auth         String   @db.VarChar(255)
  criadaEm          DateTime @default(now())

  estabelecimento Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)

  @@unique([estabelecimentoId, endpoint])
  @@index([estabelecimentoId])
}

